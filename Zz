import pandas as pd
from openpyxl import load_workbook, Workbook
from openpyxl.utils.dataframe import dataframe_to_rows

# Load the original Excel file into a DataFrame
file_path = 'tested.xlsx'
df = pd.read_excel(file_path)

# Filter the DataFrame to only include rows where the 'location' is "Singapore"
filtered_df = df[df['location'] == 'Singapore']

# Load the original workbook and the first sheet to get column widths
book = load_workbook(file_path)
sheet = book.active

# Create a new workbook and add a new sheet
new_book = Workbook()
new_sheet = new_book.active
new_sheet.title = 'FilteredData'

# Retain column widths from the original sheet
for col in sheet.columns:
    max_length = max(len(str(cell.value)) if cell.value else 0 for cell in col)
    adjusted_width = max(max_length, 8) + 2
    new_sheet.column_dimensions[col[0].column_letter].width = adjusted_width

# Add filtered data to the new sheet starting from the first row
for r_idx, row in enumerate(dataframe_to_rows(filtered_df, index=False, header=True), start=1):
    for c_idx, value in enumerate(row, start=1):
        new_sheet.cell(row=r_idx, column=c_idx, value=value)

# Save the new workbook with filtered data
output_file_path = 'filtered.xlsx'
new_book.save(output_file_path)

print(f"Filtered data with column widths has been saved to '{output_file_path}'.")

import tkinter as tk
from tkinter import filedialog, messagebox
import win32com.client

def browse_file():
    filepath = filedialog.askopenfilename(
        filetypes=[("PowerPoint Files", "*.pptx")]
    )
    entry_file_path.delete(0, tk.END)
    entry_file_path.insert(0, filepath)

def update_embedded_excel(ppt_file, data_lines):
    try:
        # Initialize PowerPoint application
        powerpoint = win32com.client.Dispatch("PowerPoint.Application")
        presentation = powerpoint.Presentations.Open(ppt_file)
        excel_app = win32com.client.Dispatch("Excel.Application")

        for slide in presentation.Slides:
            for shape in slide.Shapes:
                if shape.HasChart:
                    chart = shape.Chart
                    chart.ChartData.Activate()

                    # Access embedded Excel
                    workbook = excel_app.Workbooks(chart.ChartData.Workbook.FullName)
                    worksheet = workbook.Worksheets(1)

                    # Update the worksheet with data
                    for i, row_data in enumerate(data_lines):
                        if i < 3:  # Process only the 3 rows (2, 3, 4)
                            for j in range(4):  # Update only the first four columns
                                value = row_data[j]
                                cell = worksheet.Cells(i + 2, j + 1)  # Adjust for proper row/column indexing
                                if j == 0:
                                    cell.Value = value
                                    cell.NumberFormat = 'mmm-yy'
                                elif 1 <= j <= 3:
                                    cell.Value = float(value) / 100
                                    cell.NumberFormat = '0.00%'

                    workbook.Save()
                    workbook.Close()
                    
                    # Exit the loop after modifying the first chart found
                    break

        # Save and close the presentation
        presentation.Save()
        presentation.Close()
        powerpoint.Quit()
        excel_app.Quit()

        messagebox.showinfo("Success", "Excel table updated successfully.")
        
    except Exception as e:
        messagebox.showerror("Error", f"An error occurred while updating chart data: {e}")

def apply_updates():
    ppt_file = entry_file_path.get()
    if not ppt_file:
        messagebox.showerror("Error", "Please select a PowerPoint file.")
        return

    try:
        data_lines = entry_excel.get("1.0", tk.END).strip().splitlines()
        if len(data_lines) != 3:
            messagebox.showerror("Error", "Input must contain exactly 3 lines.")
            return

        # Process each line into a list of values
        formatted_data = [line.split() for line in data_lines]
        if any(len(row) != 4 for row in formatted_data):
            messagebox.showerror("Error", "Each line must contain exactly 4 values separated by spaces.")
            return

        update_embedded_excel(ppt_file, formatted_data)
    
    except Exception as e:
        messagebox.showerror("Error", f"An error occurred: {e}")

# Set up the main window
root = tk.Tk()
root.title("Update Embedded Excel in PowerPoint")

# File selection
tk.Label(root, text="Select PowerPoint File:").grid(row=0, column=0, padx=10, pady=5)
entry_file_path = tk.Entry(root, width=50)
entry_file_path.grid(row=0, column=1, padx=10, pady=5)
tk.Button(root, text="Browse", command=browse_file).grid(row=0, column=2, padx=10, pady=5)

# Input area for Excel replacements
tk.Label(root, text="Enter Excel Table Data (3 lines of 4 values each):").grid(row=1, column=0, padx=10, pady=5)
entry_excel = tk.Text(root, width=60, height=10)
entry_excel.grid(row=1, column=1, padx=10, pady=5)

# Apply updates button
tk.Button(root, text="Update Excel Table", command=apply_updates).grid(row=2, column=0, columnspan=3, padx=10, pady=20)

# Start the Tkinter main loop
root.mainloop()
